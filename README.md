# OCTO-PI: Веб-система видеонаблюдения

Веб-интерфейс для управления системой видеонаблюдения с распознаванием лиц и детекцией движения.

---

## Содержание

- [Требования](#требования)
- [Установка](#установка)
- [Быстрый старт](#быстрый-старт)
- [Учетные записи](#учетные-записи)
- [Функционал](#функционал)
- [Распознавание лиц](#распознавание-лиц)
- [Режим записи](#режим-записи)
- [Структура проекта](#структура-проекта)
- [Конфигурация](#конфигурация)
- [API](#api)
- [Устранение неполадок](#устранение-неполадок)
- [Технические детали](#технические-детали)
- [Лицензия](#лицензия)

---

## Требования

- Python 3.8+
- OpenCV с поддержкой opencv-contrib (для распознавания лиц)
- Веб-камера (одна или несколько)
- Поддерживаемые ОС: Windows, Linux, macOS

---

## Установка

### 1. Клонирование репозитория

```bash
git clone https://github.com/your-repo/octo-pi.git
cd octo-pi
```

### 2. Создание виртуального окружения (рекомендуется)

```bash
python -m venv venv

# Windows
venv\Scripts\activate

# Linux/macOS
source venv/bin/activate
```

### 3. Установка зависимостей

```bash
pip install -r requirements.txt
```

---

## Быстрый старт

### Запуск системы

```bash
python launcher.py
```

### Выбор режима работы

```
Select the mode:
 1) Web version (panel /web, API /docs)
 2) Terminal version (menu in the console)
 q) Exit
```

- Выберите `1` для веб-версии
- Выберите `2` для терминальной версии

### Доступ к веб-интерфейсу

После запуска веб-версии откройте в браузере:

```
http://localhost:5000/login
```

Для доступа с других устройств в локальной сети используйте IP-адрес сервера:

```
http://<IP-адрес>:5000/login
```

---

## Учетные записи

| Роль          | Логин   | Пароль    | Уровень доступа        |
|---------------|---------|-----------|------------------------|
| Администратор | admin   | admin123  | Полный доступ          |
| Пользователь  | user    | user123   | Только просмотр        |

### Права доступа по ролям

**Администратор:**
- Управление системой (запуск/остановка)
- Настройка камер
- Просмотр и фильтрация логов
- Управление масками
- Обучение модели распознавания лиц
- Загрузка фотографий для биометрии

**Пользователь:**
- Просмотр трансляции с камер
- Просмотр статуса системы

---

## Функционал

### Dashboard (Панель управления)

- Запуск и остановка системы видеонаблюдения
- Отображение текущего статуса системы
- Быстрый доступ ко всем разделам

### Live (Трансляция)

- Просмотр видео со всех камер в реальном времени
- Выбор конкретной камеры для детального просмотра
- Адаптивная сетка отображения

### Settings (Настройки) - только для администратора

| Параметр         | Описание                                      |
|------------------|-----------------------------------------------|
| Face Detection   | Включение/отключение распознавания лиц        |
| Motion Detection | Включение/отключение детекции движения        |
| Recording        | Запись видео (всегда включена по умолчанию)   |
| Triggered Mode   | Запись только при обнаружении движения        |
| Timeout          | Время ожидания между проверками               |
| Sensitivity      | Чувствительность детектора движения (5-100)   |

### Logs (Логи) - только для администратора

- Просмотр системных логов в реальном времени
- Фильтрация по уровню: INFO, SUCCESS, WARNING, ERROR
- Фильтрация по дате
- Отображение последних 100 записей

### Biometric (Биометрия) - только для администратора

- Загрузка фотографий для обучения модели
- Запуск обучения модели распознавания лиц
- Просмотр существующих пользователей в датасете

---

## Распознавание лиц

### Принцип работы

Система использует алгоритм LBPH (Local Binary Patterns Histograms) для распознавания лиц.

| Ситуация                | Цвет рамки | Отображаемый текст |
|-------------------------|------------|--------------------|
| Лицо распознано         | Зеленый    | Имя человека       |
| Лицо не распознано      | Красный    | NE RASPOZNAN       |
| Модель не обучена       | Красный    | NE RASPOZNAN       |

### Подготовка датасета

Создайте структуру папок в директории `dataset/`:

```
dataset/
├── Иван_Иванов/
│   ├── photo1.jpg
│   ├── photo2.jpg
│   └── photo3.jpg
├── Мария_Петрова/
│   ├── photo1.jpg
│   └── photo2.jpg
└── Петр_Сидоров/
    └── photo1.jpg
```

**Рекомендации по фотографиям:**
- Минимум 3-5 фотографий на человека
- Разные ракурсы и освещение
- Четкое изображение лица
- Форматы: JPG, JPEG, PNG

### Обучение модели

**Через веб-интерфейс:**
1. Перейдите в раздел Biometric
2. Загрузите фотографии для каждого пользователя
3. Нажмите кнопку "Обучить модель"

**Через терминал:**
```bash
python -c "from AI_face import learning; learning()"
```

**Результат обучения:**
- `face_model.yml` - файл обученной модели
- `labels.npy` - словарь соответствия ID и имен

---

## Режим записи

### Схема работы

```
+-------------------+------------------+-------------------+
|    ПРЕЗАПИСЬ      |     ДВИЖЕНИЕ     |     ДОЗАПИСЬ      |
|     (4 сек)       |   (все время)    |     (5 сек)       |
+-------------------+------------------+-------------------+
|   Сохраняется     |  Запись активна  |  После движения   |
|    в буфер        |                  |   еще 5 секунд    |
+-------------------+------------------+-------------------+
```

### Особенности записи

- **Презапись (4 секунды):** буфер кадров до обнаружения движения
- **Дозапись (5 секунд):** продолжение записи после прекращения движения
- **Формат:** AVI (кодек MJPG)
- **FPS:** соответствует настройкам камеры

### Структура сохранения записей

```
recordings/
└── 2025-01-15/
    └── motion_detected/
        ├── cam0/
        │   ├── recording_14-30-25.avi
        │   └── recording_14-35-10.avi
        ├── cam1/
        └── cam2/
```

---

## Структура проекта

```
OCTO-PI/
├── launcher.py           # Точка входа в приложение
├── octo_web.py           # Веб-сервер Flask
├── octo_cli.py           # Терминальная версия
├── config.py             # Конфигурация системы
├── camera_utils.py       # Утилиты работы с камерами
├── motion_detection.py   # Детектор движения
├── face_detection.py     # Детектор лиц
├── AI_face.py            # Обучение модели распознавания
├── logger.py             # Настройка логирования
├── view_logs.py          # Просмотр логов
├── requirements.txt      # Зависимости Python
├── README.md             # Документация
├── LICENSE               # Лицензия
│
├── static/               # Статические файлы
│   ├── css/
│   │   ├── login.css
│   │   └── main.css
│   └── js/
│       ├── login.js
│       └── main.js
│
├── templates/            # HTML-шаблоны
│   ├── login.html
│   └── dashboard.html
│
├── dataset/              # Фотографии для обучения (создается)
├── masks/                # Маски камер (создается)
├── recordings/           # Записи видео (создается)
└── logs/                 # Системные логи (создается)
```

---

## Конфигурация

### Файл config.py

Система автоматически определяет ОС и настраивает индексы камер:

| ОС             | Индексы камер  | Устройства               |
|----------------|----------------|--------------------------|
| Windows        | 0, 1, 2, 3     | Стандартные              |
| Linux (Ubuntu) | 0, 2, 4, 6     | /dev/video0, /dev/video2 |
| macOS          | 0, 1, 2, 3     | Стандартные              |

### Ручная настройка индексов камер

```python
# config.py
CAMERA_INDICES = [0, 2, 4, 6]  # Ваши индексы
```

### Параметры оптимизации (octo_web.py)

```python
POST_MOTION_DURATION = 5    # Секунд записи после движения
PRE_RECORD_SECONDS = 4      # Секунды презаписи
MAX_FRAME_QUEUE_SIZE = 150  # Максимальный размер буфера кадров
JPEG_QUALITY = 70           # Качество JPEG для веб-потока (1-100)
```

---

## API

### Эндпоинты системы

| Метод | Эндпоинт                  | Описание                    | Доступ |
|-------|---------------------------|-----------------------------|--------|
| POST  | /api/system/start         | Запуск системы              | Admin  |
| POST  | /api/system/stop          | Остановка системы           | Admin  |
| GET   | /api/system/status        | Статус системы              | All    |

### Эндпоинты настроек

| Метод | Эндпоинт                  | Описание                    | Доступ |
|-------|---------------------------|-----------------------------|--------|
| GET   | /api/settings/cameras     | Получить настройки камер    | Admin  |
| POST  | /api/settings/cameras     | Изменить настройки камеры   | Admin  |
| POST  | /api/settings/sensitivity | Изменить чувствительность   | Admin  |
| POST  | /api/settings/apply       | Применить настройки         | Admin  |

### Эндпоинты масок и логов

| Метод | Эндпоинт                  | Описание                    | Доступ |
|-------|---------------------------|-----------------------------|--------|
| GET   | /api/masks/list           | Список масок                | Admin  |
| POST  | /api/masks/delete         | Удалить маску               | Admin  |
| GET   | /api/logs                 | Получить логи               | All    |

### Эндпоинты биометрии

| Метод | Эндпоинт                  | Описание                    | Доступ |
|-------|---------------------------|-----------------------------|--------|
| POST  | /api/biometric/train      | Обучить модель              | Admin  |
| POST  | /api/biometric/upload     | Загрузить фотографии        | Admin  |

### Видеопоток

| Метод | Эндпоинт                  | Описание                    | Доступ |
|-------|---------------------------|-----------------------------|--------|
| GET   | /video_feed/<camera_id>   | MJPEG поток с камеры        | All    |

---

## Устранение неполадок

### Ошибка: pkgutil has no attribute 'ImpImporter'

**Причина:** numpy несовместим с Python 3.12

**Решение:**
```bash
pip install "numpy>=1.26.0" --upgrade
```

### Ошибка: unexpected keyword argument 'partitioned'

**Причина:** Устаревшая версия Werkzeug

**Решение:**
```bash
pip install "Werkzeug>=3.1.0" --upgrade
```

### Кнопки не работают (нет ошибок в консоли)

**Причина:** JavaScript загрузился до DOM

**Решение:** Очистите кэш браузера: Ctrl+Shift+R

### Сервер запускается и сразу закрывается

**Причина:** Проблемы совместимости flask-socketio

**Решение:** В текущей версии используется app.run() вместо socketio.run()

### Ошибка: "Порт 5000 занят"

**Симптом:** Сообщение о попытке доступа к занятому сокету

**Решение для Windows:**
```powershell
# Найти процесс, занимающий порт
netstat -ano | findstr :5000

# Завершить процесс (замените 12345 на реальный PID)
taskkill /PID 12345 /F

# Перезапустить приложение
python launcher.py
```

**Решение для Linux/macOS:**
```bash
# Найти и завершить процесс
lsof -ti:5000 | xargs kill -9

# Перезапустить приложение
python launcher.py
```

### Ошибка: Error loading LBPH model

**Причина:** Модель распознавания лиц не обучена

**Решение:** Это нормальное поведение при первом запуске. Система работает без распознавания. Для включения функции:
1. Добавьте фотографии в директорию dataset/
2. Обучите модель (см. раздел "Распознавание лиц")

### Камера не определяется

**Возможные причины:**
- Камера занята другим приложением
- Неверный индекс камеры
- Отсутствие драйверов

**Решение:**
1. Закройте другие приложения, использующие камеру
2. Проверьте индексы камер в config.py
3. Установите/обновите драйверы камеры

---

## Технические детали

### Используемые технологии

| Компонент             | Технология                |
|-----------------------|---------------------------|
| Backend               | Flask 3.0                 |
| Real-time             | Flask-SocketIO            |
| Frontend              | HTML5, CSS3, JavaScript   |
| Видеопоток            | MJPEG over HTTP           |
| Распознавание лиц     | OpenCV LBPH               |
| Детекция движения     | OpenCV (абсолютная разница кадров) |
| Детекция лиц          | Haar Cascades             |
| Логирование           | Loguru                    |
| Хеширование паролей   | Werkzeug                  |

### Зависимости (requirements.txt)

```
Flask==3.0.0
flask-socketio==5.3.6
opencv-python>=4.8.1.78
numpy>=1.26.0
loguru==0.7.2
Werkzeug>=3.1.0
```

### Производительность

- Оптимизировано для работы на Raspberry Pi
- Используется MJPG кодек для быстрой записи
- Динамические буферы для экономии памяти
- Многопоточная обработка камер

---

## Важные замечания

1. **Маски:** Создание масок для исключения зон доступно только в терминальной версии (python launcher.py, режим 2). В веб-версии можно только просматривать и удалять существующие маски.

2. **Безопасность:** Для production-окружения обязательно измените SECRET_KEY в octo_web.py и пароли пользователей.

3. **Windows:** На Windows используется Flask-сервер вместо SocketIO для стабильности работы.

4. **Камеры:** По умолчанию система ожидает 4 камеры. Измените CAMERA_INDICES в config.py при необходимости.

---

## Лицензия

Проект распространяется под лицензией, указанной в файле LICENSE.

---

**OCTO-PI** | Система видеонаблюдения | 2025
